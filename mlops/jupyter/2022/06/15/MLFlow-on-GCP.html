<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>MLFlow on GCP for Experiment Tracking | Isaac Kargar</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="MLFlow on GCP for Experiment Tracking" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="We will setup MLFlow on GCP for distributed experiment tracking." />
<meta property="og:description" content="We will setup MLFlow on GCP for distributed experiment tracking." />
<link rel="canonical" href="https://kargarisaac.github.io/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html" />
<meta property="og:url" content="https://kargarisaac.github.io/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html" />
<meta property="og:site_name" content="Isaac Kargar" />
<meta property="og:image" content="https://kargarisaac.github.io/blog/images/some_folder/your_image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-06-15T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"We will setup MLFlow on GCP for distributed experiment tracking.","@type":"BlogPosting","url":"https://kargarisaac.github.io/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html","dateModified":"2022-06-15T00:00:00-05:00","datePublished":"2022-06-15T00:00:00-05:00","headline":"MLFlow on GCP for Experiment Tracking","image":"https://kargarisaac.github.io/blog/images/some_folder/your_image.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://kargarisaac.github.io/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://kargarisaac.github.io/blog/feed.xml" title="Isaac Kargar" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','G-7C8WW0BBJ4','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>MLFlow on GCP for Experiment Tracking | Isaac Kargar</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="MLFlow on GCP for Experiment Tracking" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="We will setup MLFlow on GCP for distributed experiment tracking." />
<meta property="og:description" content="We will setup MLFlow on GCP for distributed experiment tracking." />
<link rel="canonical" href="https://kargarisaac.github.io/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html" />
<meta property="og:url" content="https://kargarisaac.github.io/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html" />
<meta property="og:site_name" content="Isaac Kargar" />
<meta property="og:image" content="https://kargarisaac.github.io/blog/images/some_folder/your_image.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-06-15T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"We will setup MLFlow on GCP for distributed experiment tracking.","@type":"BlogPosting","url":"https://kargarisaac.github.io/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html","dateModified":"2022-06-15T00:00:00-05:00","datePublished":"2022-06-15T00:00:00-05:00","headline":"MLFlow on GCP for Experiment Tracking","image":"https://kargarisaac.github.io/blog/images/some_folder/your_image.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://kargarisaac.github.io/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://kargarisaac.github.io/blog/feed.xml" title="Isaac Kargar" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','G-7C8WW0BBJ4','auto');ga('require','displayfeatures');ga('send','pageview');</script>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">Isaac Kargar</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">MLFlow on GCP for Experiment Tracking</h1><p class="page-description">We will setup MLFlow on GCP for distributed experiment tracking.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-06-15T00:00:00-05:00" itemprop="datePublished">
        Jun 15, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      7 min read
    
</span></p>

    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/kargarisaac/blog/tree/master/_notebooks/2022-06-15-MLFlow-on-GCP.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/blog/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/kargarisaac/blog/master?filepath=_notebooks%2F2022-06-15-MLFlow-on-GCP.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/kargarisaac/blog/blob/master/_notebooks/2022-06-15-MLFlow-on-GCP.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/blog/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#Virtual-Machine-as-The-Tracking-Server">Virtual Machine as The Tracking Server </a></li>
<li class="toc-entry toc-h1"><a href="#Database-as-the-Backend-Store">Database as the Backend Store </a></li>
<li class="toc-entry toc-h1"><a href="#Google-Cloud-Storage-Bucket-as-Artifact-Store">Google Cloud Storage Bucket as Artifact Store </a></li>
<li class="toc-entry toc-h1"><a href="#Run-the-MLFlow-Server-on-Tracking-Server">Run the MLFlow Server on Tracking Server </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-06-15-MLFlow-on-GCP.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>I searched over the internet and couldn't find a good step by step tutorial on setting up MLFlow on GCP. That's why I decided to write a tutorial on that.</p>
<p>In this blog post, I will show the steps to setup MLFlow on Google Cloud for distributed experiment tracking. MLFlow can be used for machine learning experiment tracking. There are several ways to use MLFLow which you can check them <a href="https://www.mlflow.org/docs/latest/tracking.html">here</a>.</p>
<p>The architecture that we want to implement here is like scenario number 5 and would be as the following image:</p>
<p><img src="/blog/images/copied_from_nb/images/mlflow-gcp/scenario_5.png" alt="">
<em><a href="https://www.mlflow.org/docs/latest/tracking.html#scenario-5-mlflow-tracking-server-enabled-with-proxied-artifact-storage-access">source</a></em></p>
<p>This is useful for teams with multiple data scientists to have one tracking server to be shared between all of them. So they all can do their experimentation and have everything in one place. The tracking server is not also dependent on the backend store and artifact store and can be scaled. In addition, the scientists will not lose their local data if they want to scale their machine or change it. Everything is decentralised.</p>
<p>Here is the explanation from MLFLow documentation:</p>
<blockquote>
<p>MLflow’s Tracking Server supports utilizing the host as a proxy server for operations involving artifacts. Once configured with the appropriate access requirements, an administrator can start the tracking server to enable assumed-role operations involving the saving, loading, or listing of model artifacts, images, documents, and files. This eliminates the need to allow end users to have direct path access to a remote object store (e.g., s3, adls, gcs, hdfs) for artifact handling and eliminates the need for an end-user to provide access credentials to interact with an underlying object store. <br><br>
Enabling the Tracking Server to perform proxied artifact access in order to route client artifact requests to an object store location:<br><br><strong>Part 1a and b:</strong><br><br>
The MLflow client creates an instance of a RestStore and sends REST API requests to log MLflow entities.<br><br>
The Tracking Server creates an instance of an SQLAlchemyStore and connects to the remote host for inserting tracking information in the database (i.e., metrics, parameters, tags, etc.)<br><br>
<strong>Part 1c and d:</strong><br><br>
Retrieval requests by the client return information from the configured SQLAlchemyStore table<br><br>
<strong>Part 2a and b:</strong><br><br>
Logging events for artifacts are made by the client using the HttpArtifactRepository to write files to MLflow Tracking Server<br><br>
The Tracking Server then writes these files to the configured object store location with assumed role authentication<br><br>
<strong>Part 2c and d:</strong><br><br>
Retrieving artifacts from the configured backend store for a user request is done with the same authorized authentication that was configured at server start<br><br>
Artifacts are passed to the end user through the Tracking Server through the interface of the HttpArtifactRepository</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this distributed architecture, we will have :</p>
<ul>
<li>one virtual machine as tracking server</li>
<li>one google storage bucket as artifact store - persists artifacts (files, models, images, in-memory objects, or model summary, etc).</li>
<li>one PostgreSQL as backend store - persists MLflow entities (runs, parameters, metrics, tags, notes, metadata, etc).</li>
</ul>
<p>The architecture on GCP would be like the following image:</p>
<p><img src="/blog/images/copied_from_nb/images/mlflow-gcp/3.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Virtual-Machine-as-The-Tracking-Server">
<a class="anchor" href="#Virtual-Machine-as-The-Tracking-Server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Virtual Machine as The Tracking Server<a class="anchor-link" href="#Virtual-Machine-as-The-Tracking-Server"> </a>
</h1>
<p>We need a firewall rule which can be created like the following:</p>
<div class="highlight"><pre><span></span>gcloud compute firewall-rules create mlflow-tracking-server <span class="se">\</span>
    --network default <span class="se">\</span>
    --priority <span class="m">1000</span> <span class="se">\</span>
    --direction ingress <span class="se">\</span>
    --action allow <span class="se">\</span>
    --target-tags mlflow-tracking-server <span class="se">\</span>
    --source-ranges <span class="m">0</span>.0.0.0/0 <span class="se">\</span>
    --rules tcp:5000 <span class="se">\</span>
    --enable-logging
</pre></div>
<p>Here is the firewall rule after creation:</p>
<p><img src="/blog/images/copied_from_nb/images/mlflow-gcp/1.png" alt=""></p>
<p>We then can create a virtual instance as the tracking server.</p>
<div class="highlight"><pre><span></span>gcloud compute instances create mlflow-tracking-server <span class="se">\</span>
    --project<span class="o">=</span>&lt;PROJECT_ID&gt; <span class="se">\</span>
    --zone<span class="o">=</span>europe-west1-b <span class="se">\</span>
    --machine-type<span class="o">=</span>e2-standard-2 <span class="se">\</span>
    --network-interface<span class="o">=</span>network-tier<span class="o">=</span>PREMIUM,subnet<span class="o">=</span>default <span class="se">\</span>
    --maintenance-policy<span class="o">=</span>MIGRATE <span class="se">\</span>
    --provisioning-model<span class="o">=</span>STANDARD <span class="se">\</span>
    --service-account<span class="o">=</span>&lt;PROJECT_NUMBER&gt;-compute@developer.gserviceaccount.com <span class="se">\</span>
    --scopes<span class="o">=</span>https://www.googleapis.com/auth/cloud-platform <span class="se">\</span>
    --tags<span class="o">=</span>mlflow-tracking-server <span class="se">\</span>
    --create-disk<span class="o">=</span>auto-delete<span class="o">=</span>yes,boot<span class="o">=</span>yes,device-name<span class="o">=</span>mlflow-tracking-server,image<span class="o">=</span>projects/ubuntu-os-cloud/global/images/ubuntu-2004-focal-v20220610,mode<span class="o">=</span>rw,size<span class="o">=</span><span class="m">10</span>,type<span class="o">=</span>projects/&lt;PROJECT_ID&gt;/zones/europe-west1-b/diskTypes/pd-balanced <span class="se">\</span>
    --no-shielded-secure-boot <span class="se">\</span>
    --shielded-vtpm <span class="se">\</span>
    --shielded-integrity-monitoring <span class="se">\</span>
    --reservation-affinity<span class="o">=</span>any
</pre></div>
<p>change <code>PROJECT_ID</code> based on your project. You can also change other configs like zone, machine, etc. if you want. Note that you have to change them in multiple places. The service account is the default service account for compute engine and is as follows:</p>
<div class="highlight"><pre><span></span>PROJECT_NUMBER-compute@developer.gserviceaccount.com
</pre></div>
<p>Where <code>PROJECT_NUMBER</code> is the project number of the project that owns the service account. You can find it <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects#identifying_projects">here</a>.</p>
<p>You can also use the UI to simply create the virtual machine. Just make sure you use the <code>default</code> network for VPC and the created firewall rule for the <code>networks tags</code> in the <code>Network Interfaces</code> section. Also give the VM <code>Allow full access to all Cloud APIs</code>i in the Management -&gt; availability policies section.</p>
<p>Here is the networking section of the VM after creation (other configs can be based on your choice):</p>
<p><img src="/blog/images/copied_from_nb/images/mlflow-gcp/2.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Database-as-the-Backend-Store">
<a class="anchor" href="#Database-as-the-Backend-Store" aria-hidden="true"><span class="octicon octicon-link"></span></a>Database as the Backend Store<a class="anchor-link" href="#Database-as-the-Backend-Store"> </a>
</h1>
<p>We also need a PostgreSQL database as the backend store.</p>
<ul>
<li>Go to GCP dashboard and search for SQL and then select <code>create instance</code> and the select <code>PostgreSQL</code>.</li>
<li>Put a name and password for the instance. Select the Database version and region. You can choose one option for Zonal availability too. </li>
<li>Expand the <code>Customize your instance</code> part, and in connections, select <code>Private IP</code> and deselect <code>Public IP</code> and from the drop down options for <code>Network</code> in <code>Private IP</code> part, select <code>default</code>. This is the VPC which our virtual machine should be also on it too. So the VM and DB can see eachother.</li>
<li>You can change other configs for the DB too. I leave them as their default values.</li>
<li>Select <code>Create Instance</code> option.</li>
</ul>
<p>It will take you to the overview page and will take some time to create the database instance. Then we can create a database. GCP will create a default one named <code>postgres</code>, but I will create a new one.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then go to the <code>Databases</code> section and select <code>Create Database</code> and name it <code>mlflow_db</code>, for example.</p>
<p>Then we need to create a user too. Go to the <code>User</code> section and click on the <code>Add User Account</code>. Select a username and password for that.</p>
<p>Now, you should be able to connect to the tracking server via ssh and run the following command to install and then see the list of databases. You can see the created database with its private IP.</p>
<div class="highlight"><pre><span></span>sudo apt-get update
sudo apt-get install postgresql-client
gcloud sql instances list
</pre></div>
<p>Then run the following command to see if you can connect to the database.</p>
<div class="highlight"><pre><span></span>psql -h CLOUD_SQL_PRIVATE_IP_ADDRESS -U USERNAME DATABASENAME
</pre></div>
<p>It will ask you for the password for the user you created before.</p>
<p>Now that you can connect to the database from the tracking server using private IP, let's go to the next part.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Google-Cloud-Storage-Bucket-as-Artifact-Store">
<a class="anchor" href="#Google-Cloud-Storage-Bucket-as-Artifact-Store" aria-hidden="true"><span class="octicon octicon-link"></span></a>Google Cloud Storage Bucket as Artifact Store<a class="anchor-link" href="#Google-Cloud-Storage-Bucket-as-Artifact-Store"> </a>
</h1>
<p>In the google cloud dashboard, search for <code>cloud storage</code> and then select <code>Create Bucket</code>. Do the required configs and done. You can also create a folder like <code>mlruns</code> in the bucket.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Run-the-MLFlow-Server-on-Tracking-Server">
<a class="anchor" href="#Run-the-MLFlow-Server-on-Tracking-Server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Run the MLFlow Server on Tracking Server<a class="anchor-link" href="#Run-the-MLFlow-Server-on-Tracking-Server"> </a>
</h1>
<p>Now we have all the resources. Go back to the ssh terminal for the tracking server or connect to it again. I had some problems with installing the required python packages. So I created a virtual env and installed the packages there.</p>
<div class="highlight"><pre><span></span>sudo apt install python3.8-venv
python3 -m venv mlflow
<span class="nb">source</span> mlflow/bin/activate
pip install mlflow boto3 google-cloud-storage psycopg2-binary
</pre></div>
<p>Then run the mlflow server:</p>
<div class="highlight"><pre><span></span>mlflow server <span class="se">\</span>
    -h <span class="m">0</span>.0.0.0 <span class="se">\</span>
    -p <span class="m">5000</span> <span class="se">\</span>
    --backend-store-uri postgresql://&lt;user&gt;:&lt;pass&gt;@&lt;db private ip&gt;:5432/&lt;db name&gt; <span class="se">\</span>
    --default-artifact-root gs://&lt;bucket name&gt;/&lt;folder name&gt;
</pre></div>
<p>Then you can go to <code>http:&lt;tracking server external IP&gt;:5000</code> address and you should see the mlflow UI!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, you can train a model on your machine or another VM and log mlflow data.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">TRACKING_SERVER_HOST</span> <span class="o">=</span> <span class="s2">"&lt;tracking server external IP&gt;"</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="sa">f</span><span class="s2">"http://</span><span class="si">{</span><span class="n">TRACKING_SERVER_HOST</span><span class="si">}</span><span class="s2">:5000"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"tracking URI: '</span><span class="si">{</span><span class="n">mlflow</span><span class="o">.</span><span class="n">get_tracking_uri</span><span class="p">()</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">"my-experiment-1"</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">():</span>

    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">(</span><span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"C"</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">"random_state"</span><span class="p">:</span> <span class="mi">42</span><span class="p">}</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">"accuracy"</span><span class="p">,</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">artifact_path</span><span class="o">=</span><span class="s2">"models"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"default artifacts URI: '</span><span class="si">{</span><span class="n">mlflow</span><span class="o">.</span><span class="n">get_artifact_uri</span><span class="p">()</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">list_experiments</span><span class="p">()</span>
</pre></div>
<p>Note that you need to install <code>google-cloud-storage</code> via pip on your machine.</p>
<p>You should now see <code>my-experiment-1</code> in the output of the above code and also in UI (refresh the page if you don't see it).</p>
<p>You can also assign a fixed external IP address for your tracking server. So you don't need to change it in the code everytime you start the VM. You can do this by going to the <code>IP addresses</code> section in <code>VPC network</code> as shown in the below image:</p>
<p><img src="/blog/images/copied_from_nb/images/mlflow-gcp/4.png" alt=""></p>
<p>Now if you check the <code>mlflow-tracking-server</code> VM, you should see the External IP even if the VM is stopped.</p>
<p>That's it for this post. I will try to replace VM with cloud run in future posts. I also think about having a login UI that each user should sign in to access the mlflow UI.</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="kargarisaac/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/mlops/jupyter/2022/06/15/MLFlow-on-GCP.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>My posts about Machine Learning</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/kargarisaac" target="_blank" title="kargarisaac"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://www.linkedin.com/in/eshagh-kargar" target="_blank" title="eshagh-kargar"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#linkedin"></use></svg></a></li><li><a rel="me" href="https://twitter.com/kargarisaac" target="_blank" title="kargarisaac"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
